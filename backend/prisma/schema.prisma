// Prisma Schema - Base de Datos E-commerce

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELO: Producto
// ============================================
model Producto {
  id               String   @id @default(uuid())
  nombre           String   @db.VarChar(200)
  descripcion      String   @db.Text
  slug             String   @unique @db.VarChar(255)
  precio           Decimal  @db.Decimal(10, 2)
  precioAnterior   Decimal? @db.Decimal(10, 2)
  stock            Int      @default(0)
  imagenPrincipal  String   @db.VarChar(500)
  imagenes         String[] @default([])
  categoriaId      String
  categoria        String   @db.VarChar(100)
  etiquetas        String[] @default([])
  caracteristicas  Json     @default("{}")
  activo           Boolean  @default(true)
  destacado        Boolean  @default(false)
  fechaCreacion    DateTime @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")

  // Relaciones
  itemsPedido ItemPedido[]

  @@index([categoriaId])
  @@index([slug])
  @@index([activo, destacado])
  @@index([precio])
  @@map("productos")
}

// ============================================
// MODELO: Usuario
// ============================================
model Usuario {
  id                  String    @id @default(uuid())
  email               String    @unique @db.VarChar(255)
  password            String    @db.VarChar(255)
  nombre              String    @db.VarChar(200)
  apellido            String?   @db.VarChar(200)
  telefono            String?   @db.VarChar(20)
  rol                 String    @default("cliente") @db.VarChar(50) // cliente, admin
  activo              Boolean   @default(true)
  emailVerificado     Boolean   @default(false) @map("email_verificado")
  refreshTokenHash    String?   @db.VarChar(255) @map("refresh_token_hash")
  refreshTokenExpira  DateTime? @map("refresh_token_expira")

  // Campos OAuth
  proveedorOAuth      String?   @db.VarChar(50) @map("proveedor_oauth") // facebook, google
  proveedorId         String?   @db.VarChar(255) @map("proveedor_id")
  foto                String?   @db.VarChar(500)

  fechaCreacion       DateTime  @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime  @updatedAt @map("fecha_actualizacion")

  // Relaciones
  pedidos     Pedido[]
  direcciones Direccion[]

  @@index([email])
  @@index([proveedorOAuth, proveedorId])
  @@map("usuarios")
}

// ============================================
// MODELO: Dirección
// ============================================
model Direccion {
  id              String   @id @default(uuid())
  usuarioId       String   @map("usuario_id")
  nombre          String   @db.VarChar(100) // "Casa", "Oficina"
  direccionLinea1 String   @db.VarChar(255) @map("direccion_linea_1")
  direccionLinea2 String?  @db.VarChar(255) @map("direccion_linea_2")
  ciudad          String   @db.VarChar(100)
  departamento    String   @db.VarChar(100)
  codigoPostal    String?  @db.VarChar(20) @map("codigo_postal")
  telefono        String   @db.VarChar(20)
  predeterminada  Boolean  @default(false)
  fechaCreacion   DateTime @default(now()) @map("fecha_creacion")

  // Relaciones
  usuario Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  pedidos Pedido[]

  @@index([usuarioId])
  @@map("direcciones")
}

// ============================================
// MODELO: Pedido
// ============================================
model Pedido {
  id                 String   @id @default(uuid())
  usuarioId          String   @map("usuario_id")
  direccionId        String   @map("direccion_id")
  estado             String   @default("pendiente") @db.VarChar(50) // pendiente, confirmado, enviado, entregado, cancelado
  subtotal           Decimal  @db.Decimal(10, 2)
  impuestos          Decimal  @db.Decimal(10, 2)
  envio              Decimal  @db.Decimal(10, 2)
  total              Decimal  @db.Decimal(10, 2)
  metodoPago         String   @db.VarChar(50) @map("metodo_pago") // recurrente, stripe, fri, cod
  estadoPago         String   @default("pendiente") @db.VarChar(50) @map("estado_pago") // pendiente, pagado, fallido, reembolsado
  notasCliente       String?  @db.Text @map("notas_cliente")
  fechaCreacion      DateTime @default(now()) @map("fecha_creacion")
  fechaActualizacion DateTime @updatedAt @map("fecha_actualizacion")

  // Relaciones
  usuario   Usuario      @relation(fields: [usuarioId], references: [id])
  direccion Direccion    @relation(fields: [direccionId], references: [id])
  items     ItemPedido[]
  pago      Pago?

  @@index([usuarioId])
  @@index([estado])
  @@index([fechaCreacion])
  @@map("pedidos")
}

// ============================================
// MODELO: Item de Pedido
// ============================================
model ItemPedido {
  id          String  @id @default(uuid())
  pedidoId    String  @map("pedido_id")
  productoId  String  @map("producto_id")
  cantidad    Int
  precioUnitario Decimal @db.Decimal(10, 2) @map("precio_unitario")
  subtotal    Decimal @db.Decimal(10, 2)

  // Relaciones
  pedido   Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto Producto @relation(fields: [productoId], references: [id])

  @@index([pedidoId])
  @@index([productoId])
  @@map("items_pedido")
}

// ============================================
// MODELO: Pago
// ============================================
model Pago {
  id                   String   @id @default(uuid())
  pedidoId             String   @unique @map("pedido_id")
  metodoPago           String   @db.VarChar(50) @map("metodo_pago")
  proveedor            String   @db.VarChar(50) // recurrente, stripe, fri
  transaccionId        String?  @unique @db.VarChar(255) @map("transaccion_id")
  estado               String   @db.VarChar(50) // pendiente, completado, fallido, reembolsado
  monto                Decimal  @db.Decimal(10, 2)
  moneda               String   @default("GTQ") @db.VarChar(3)
  metadatos            Json?    @default("{}")
  fechaCreacion        DateTime @default(now()) @map("fecha_creacion")
  fechaActualizacion   DateTime @updatedAt @map("fecha_actualizacion")

  // Relaciones
  pedido Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([transaccionId])
  @@index([estado])
  @@map("pagos")
}

// ============================================
// MODELO: Orden (Guest Checkout)
// ============================================
model Orden {
  id                  String   @id @default(uuid())
  numeroOrden         String   @unique @db.VarChar(20) @map("numero_orden")

  // Información del cliente (sin cuenta)
  nombreCompleto      String   @db.VarChar(200) @map("nombre_completo")
  telefono            String   @db.VarChar(8)
  email               String?  @db.VarChar(255)

  // Dirección de envío
  direccion           String   @db.VarChar(500)
  departamento        String   @db.VarChar(100)
  municipio           String   @db.VarChar(100)
  zonaOColonia        String   @db.VarChar(100) @map("zona_o_colonia")
  referencia          String?  @db.VarChar(200)

  // Detalles de la orden
  estado              String   @default("pendiente") @db.VarChar(50) // pendiente, confirmada, en_proceso, enviada, entregada, cancelada
  metodoPago          String   @db.VarChar(50) @map("metodo_pago") // tarjeta_gt, billetera_fri, contra_entrega, tarjeta_internacional

  // Totales
  subtotal            Decimal  @db.Decimal(10, 2)
  impuestos           Decimal  @db.Decimal(10, 2)
  envio               Decimal  @db.Decimal(10, 2)
  total               Decimal  @db.Decimal(10, 2)

  // Notas
  notas               String?  @db.Text

  // Información de pago (PayPal, Stripe, etc.)
  paypalOrderId       String?  @map("paypal_order_id") @db.VarChar(255)
  paypalCaptureId     String?  @map("paypal_capture_id") @db.VarChar(255)

  // Información de pago (Recurrente)
  recurrenteCheckoutId     String?  @map("recurrente_checkout_id") @db.VarChar(255)
  recurrenteTransactionId  String?  @map("recurrente_transaction_id") @db.VarChar(255)

  estadoPago          String   @default("pendiente") @db.VarChar(50) @map("estado_pago") // pendiente, completado, fallido

  // Timestamps
  fechaCreacion       DateTime @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime @updatedAt @map("fecha_actualizacion")

  // Relaciones
  items ItemOrden[]

  @@index([numeroOrden])
  @@index([estado])
  @@index([telefono])
  @@index([fechaCreacion])
  @@map("ordenes")
}

// ============================================
// MODELO: Item de Orden (Guest)
// ============================================
model ItemOrden {
  id              String  @id @default(uuid())
  ordenId         String  @map("orden_id")
  productoId      String  @map("producto_id")
  nombreProducto  String  @db.VarChar(200) @map("nombre_producto")
  cantidad        Int
  precioUnitario  Decimal @db.Decimal(10, 2) @map("precio_unitario")
  subtotal        Decimal @db.Decimal(10, 2)

  // Relaciones
  orden   Orden @relation(fields: [ordenId], references: [id], onDelete: Cascade)

  @@index([ordenId])
  @@index([productoId])
  @@map("items_orden")
}

// ============================================
// MODELO: Asociado
// ============================================
model Asociado {
  id                  String   @id @default(uuid())
  nombre              String   @db.VarChar(200)
  cargo               String   @db.VarChar(100)
  empresa             String?  @db.VarChar(200)
  descripcion         String?  @db.Text
  foto                String?  @db.VarChar(500)
  linkedin            String?  @db.VarChar(255)
  twitter             String?  @db.VarChar(255)
  sitioWeb            String?  @db.VarChar(255) @map("sitio_web")
  orden               Int      @default(0)
  activo              Boolean  @default(true)
  destacado           Boolean  @default(false)
  fechaIngreso        DateTime @default(now()) @map("fecha_ingreso")
  fechaCreacion       DateTime @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime @updatedAt @map("fecha_actualizacion")

  @@index([activo, orden])
  @@index([destacado])
  @@map("asociados")
}

// ============================================
// MODELO: Solicitud de Asociado
// ============================================
model SolicitudAsociado {
  id                  String   @id @default(uuid())
  nombre              String   @db.VarChar(200)
  email               String   @db.VarChar(255)
  telefono            String   @db.VarChar(20)
  empresa             String?  @db.VarChar(200)
  cargo               String?  @db.VarChar(100)
  mensaje             String   @db.Text
  estado              String   @default("pendiente") @db.VarChar(50) // pendiente, revisando, aprobada, rechazada
  notasAdmin          String?  @db.Text @map("notas_admin")
  leida               Boolean  @default(false)
  fechaCreacion       DateTime @default(now()) @map("fecha_creacion")
  fechaActualizacion  DateTime @updatedAt @map("fecha_actualizacion")

  @@index([estado])
  @@index([leida])
  @@index([fechaCreacion])
  @@map("solicitudes_asociado")
}
